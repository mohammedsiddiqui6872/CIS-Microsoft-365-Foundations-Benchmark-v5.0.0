#
# Module manifest for module 'CIS-M365-Benchmark'
#
# Generated by: Mohammed Siddiqui
#
# Generated on: 2025-01-11
#

@{

# Script module or binary module file associated with this manifest.
RootModule = 'CIS-M365-Benchmark.psm1'

# Version number of this module.
ModuleVersion = '2.3.7'

# Supported PSEditions
CompatiblePSEditions = @('Desktop', 'Core')

# ID used to uniquely identify this module
GUID = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'

# Author of this module
Author = 'Mohammed Siddiqui'

# Company or vendor of this module
CompanyName = 'Community'

# Copyright statement for this module
Copyright = '(c) 2025 Mohammed Siddiqui. All rights reserved. MIT License.'

# Description of the functionality provided by this module
Description = 'Comprehensive PowerShell script that audits Microsoft 365 environments against all 130 CIS Microsoft 365 Foundations Benchmark v5.0.0 controls. Features 68% automated compliance checks with HTML and CSV reporting. Covers M365 Admin Center, Defender, Purview, Intune, Entra ID, Exchange, SharePoint, Teams, and Power BI security controls.'

# Minimum version of the PowerShell engine required by this module
PowerShellVersion = '5.1'

# Name of the PowerShell host required by this module
# PowerShellHostName = ''

# Minimum version of the PowerShell host required by this module
# PowerShellHostVersion = ''

# Minimum version of Microsoft .NET Framework required by this module. This prerequisite is valid for the PowerShell Desktop edition only.
# DotNetFrameworkVersion = ''

# Minimum version of the common language runtime (CLR) required by this module. This prerequisite is valid for the PowerShell Desktop edition only.
# ClrVersion = ''

# Processor architecture (None, X86, Amd64) required by this module
# ProcessorArchitecture = ''

# Modules that must be imported into the global environment prior to importing this module
# Note: Dependencies are checked at runtime with option to install
# RequiredModules = @()

# Assemblies that must be loaded prior to importing this module
# RequiredAssemblies = @()

# Script files (.ps1) that are run in the caller's environment prior to importing this module.
# ScriptsToProcess = @()

# Type files (.ps1xml) to be loaded when importing this module
# TypesToProcess = @()

# Format files (.ps1xml) to be loaded when importing this module
# FormatsToProcess = @()

# Modules to import as nested modules of the module specified in RootModule/ModuleToProcess
# NestedModules = @()

# Functions to export from this module, for best performance, do not use wildcards and do not delete the entry, use an empty array if there are no functions to export.
FunctionsToExport = @(
    'Connect-CISBenchmark',
    'Invoke-CISBenchmark',
    'Get-CISBenchmarkControl',
    'Test-CISBenchmarkPrerequisites',
    'Get-CISBenchmarkInfo'
)

# Cmdlets to export from this module, for best performance, do not use wildcards and do not delete the entry, use an empty array if there are no cmdlets to export.
CmdletsToExport = @()

# Variables to export from this module
VariablesToExport = @()

# Aliases to export from this module, for best performance, do not use wildcards and do not delete the entry, use an empty array if there are no aliases to export.
AliasesToExport = @()

# DSC resources to export from this module
# DscResourcesToExport = @()

# List of all modules packaged with this module
# ModuleList = @()

# List of all files packaged with this module
FileList = @(
    'CIS-M365-Benchmark.psm1',
    'CIS-M365-Compliance-Checker.ps1',
    'README.md',
    'CHANGELOG.md',
    'PERMISSIONS.md',
    'LICENSE'
)

# Private data to pass to the module specified in RootModule/ModuleToProcess. This may also contain a PSData hashtable with additional module metadata used by PowerShell.
PrivateData = @{

    PSData = @{

        # Tags applied to this module. These help with module discovery in online galleries.
        Tags = @('CIS', 'Microsoft365', 'M365', 'Compliance', 'Security', 'Audit', 'Benchmark', 'EntraID', 'AzureAD', 'Exchange', 'SharePoint', 'Teams', 'Intune', 'Defender', 'Purview', 'SecurityCompliance', 'GRC', 'RiskManagement')

        # A URL to the license for this module.
        LicenseUri = 'https://github.com/mohammedsiddiqui6872/CIS-Microsoft-365-Foundations-Benchmark-v5.0.0/blob/main/LICENSE'

        # A URL to the main website for this project.
        ProjectUri = 'https://github.com/mohammedsiddiqui6872/CIS-Microsoft-365-Foundations-Benchmark-v5.0.0'

        # A URL to an icon representing this module.
        IconUri = 'https://raw.githubusercontent.com/mohammedsiddiqui6872/CIS-Microsoft-365-Foundations-Benchmark-v5.0.0/main/.github/icon.png'

        # ReleaseNotes of this module
        ReleaseNotes = @'
## v2.3.7 - Bug Fix for Microsoft Authenticator Number Matching Detection

### Critical Fix - Control 5.2.3.1
- **Fixed Control 5.2.3.1**: Corrected hashtable property access for Microsoft Authenticator settings
  - Control 5.2.3.1 "Ensure Microsoft Authenticator is configured to protect against MFA fatigue" was returning empty value for number matching
  - Issue was caused by incorrect nested hashtable property access in PowerShell
  - Now correctly reads both `numberMatchingRequiredState.state` and `displayAppInformationRequiredState.state`
  - Users with number matching enabled will now see "Pass" instead of "Fail" with empty details

### What This Fixes
- Number matching detection now works correctly
- No more false "Fail" results when number matching is properly configured
- Proper display of both number matching and app context status in reports

### Technical Details
Changed from direct property access (`$featureSettings.numberMatchingRequiredState.state`) to hashtable key access (`$featureSettings.numberMatchingRequiredState['state']`) to correctly read nested Graph API response objects.

## v2.3.6 - Critical Fix for False Positive

### Critical Fix - Control 5.1.2.4
- **Fixed FALSE POSITIVE on Control 5.1.2.4**: Changed from automated to manual check
  - Control 5.1.2.4 "Ensure access to the Entra admin center is restricted" was incorrectly reporting failures
  - Microsoft does NOT provide a Graph API to check this setting programmatically
  - The script was incorrectly checking `AllowedToReadOtherUsers` which is a DIFFERENT setting
  - This control is now properly marked as **MANUAL** per CIS Benchmark specifications

### What This Means
- Users will no longer see false "Fail" results for control 5.1.2.4
- The control now shows "Manual" status with instructions to verify in the portal
- Check: Entra Admin Center > Identity > Users > User settings > "Restrict access to Microsoft Entra admin center"

### Why This Change
According to Microsoft documentation, the "Restrict access to Microsoft Entra administration portal" setting can ONLY be viewed/configured through the portal - no API exists to check this setting programmatically.

## v2.3.5 - Bug Fix Release

### Critical Fix
- **Fixed ProfileLevel Parameter**: The -ProfileLevel parameter now correctly filters controls
  - ProfileLevel="L1" now shows ONLY L1 controls (previously showed L2 as well)
  - ProfileLevel="L2" now shows ONLY L2 controls
  - ProfileLevel="All" continues to show all controls (default)

## v2.3.4 - Cleanup Release

### Changes
- Removed test/preview script from repository to keep package clean
- Production-ready files only in PowerShell Gallery distribution

## v2.3.3 - Enhanced HTML Reports with Floating Action Buttons

### Major Enhancement - Modern Interactive Report Design

**NEW: Floating Action Buttons & Compact Footer**

We've completely redesigned the HTML report interface to match modern web application standards with chatbot-style floating action buttons.

### New Features

- **Floating Action Buttons**: Five beautifully designed circular buttons fixed to the right side of the screen
  - View on GitHub - Direct link to repository
  - Report Issues - Quick access to issue tracker
  - Submit Feedback - Open new issue form
  - Let's Chat! - Connect via LinkedIn
  - Buy Me a Coffee - Support the project
- **Professional SVG Icons**: Cross-browser compatible vector icons with smooth hover animations
- **Interactive Tooltips**: Hover over buttons to see descriptive tooltips
- **Gradient Backgrounds**: Modern gradient effects with glow on hover
- **Compact Footer**: Single-line footer with essential information (toolkit name, date, control count, user)
- **Tenant Context Display**: Shows tenant ID and authenticated user in report header
- **Consistent Styling**: Dark theme (#0a0a0c background, #60a5fa accents) across all reports

### Visual Enhancements

- **Fixed Positioning**: Action buttons remain accessible while scrolling through long reports
- **Smooth Animations**: Scale and glow effects on hover for better user experience
- **Responsive Design**: Works seamlessly on all screen sizes
- **Professional Appearance**: Matches enterprise-grade security dashboards

### Benefits

- **Easier Access**: Quick links to documentation and support without scrolling to footer
- **Better UX**: Chatbot-style interface familiar to modern web users
- **More Engagement**: Prominent calls-to-action for feedback and support
- **Professional**: Enterprise-quality design for security compliance reports

### Technical Details

- All icons use inline SVG for maximum compatibility
- CSS transitions for smooth hover effects
- Z-index positioning ensures buttons stay on top
- Tooltips use CSS pseudo-elements (no JavaScript required)
- Single-line footer reduces vertical space usage by 50%

## v2.3.2 - New Connect-CISBenchmark Function + Enhanced Authentication

### Major Enhancement - Dedicated Authentication Function

**NEW: `Connect-CISBenchmark` - Authenticate Before Running Assessment**

We've added a dedicated authentication function that follows Microsoft's best practices for PowerShell module authentication.

### New Features

- **Connect-CISBenchmark Function**: Dedicated function for Microsoft Graph authentication
- **Improved Authentication**: Browser-based authentication with better error handling
- **Enhanced Compatibility**: Works reliably in both PowerShell 5.1 and PowerShell 7+
- **Fixed Auto-Detection**: Resolved tenant domain detection issues
- **Cleaner Module Loading**: Microsoft.Graph modules no longer pre-loaded to avoid conflicts

### Breaking Changes

**NEW RECOMMENDED WORKFLOW:**

```powershell
# Step 1: Authenticate first
Connect-CISBenchmark

# Step 2: Run assessment (auto-detects tenant info)
Invoke-CISBenchmark
```

**OLD WORKFLOW STILL WORKS:**

```powershell
# Direct invocation still supported
Invoke-CISBenchmark -TenantDomain "tenant.onmicrosoft.com" -SharePointAdminUrl "https://tenant-admin.sharepoint.com"
```

### Usage Examples

```powershell
# Easiest way - authenticate then run
Connect-CISBenchmark
Invoke-CISBenchmark

# With device code authentication
Connect-CISBenchmark -UseDeviceCode
Invoke-CISBenchmark

# Manual parameters still work
Connect-CISBenchmark
Invoke-CISBenchmark -TenantDomain "tenant.onmicrosoft.com" -SharePointAdminUrl "https://tenant-admin.sharepoint.com"
```

### Technical Improvements

- **Module Loading**: Microsoft.Graph.Authentication is now loaded on-demand instead of during module import
- **Authentication Reliability**: Uses `-ContextScope Process` for better session management
- **Array Handling**: Fixed PowerShell array indexing quirk in tenant detection
- **Error Handling**: Better error messages and troubleshooting guidance

### Benefits

- **More Reliable**: Improved authentication flow with better error handling
- **Better UX**: Clear separation between authentication and assessment
- **Fewer Issues**: Eliminates Microsoft.Graph version conflicts during module load
- **Flexible**: Supports both browser and device code authentication

## v2.3.0 - Zero-Parameter Usage (Just Like Microsoft ZeroTrustAssessment!)

### Major Enhancement - Auto-Detection of Tenant Information

**NOW YOU CAN JUST RUN: `Invoke-CISBenchmark`**

No parameters needed! The module automatically detects:
- Your Microsoft 365 tenant domain
- Your SharePoint admin URL

### New Features

- **Zero-Parameter Usage**: Simply run `Invoke-CISBenchmark` without any parameters
- **Auto-Detection**: Automatically connects to Microsoft Graph and retrieves tenant information
- **Fallback Support**: Manual parameters still work if auto-detection fails
- **Works Like Microsoft Modules**: Same experience as `Invoke-ZeroTrustAssessment`

### Usage Examples

```powershell
# Easiest way - just run it!
Invoke-CISBenchmark

# With profile level
Invoke-CISBenchmark -ProfileLevel "L1"

# Manual parameters still work
Invoke-CISBenchmark -TenantDomain "tenant.onmicrosoft.com" -SharePointAdminUrl "https://tenant-admin.sharepoint.com"
```

### How Auto-Detection Works

1. Connects to Microsoft Graph with Organization.Read.All scope
2. Retrieves organization details including verified domains
3. Detects *.onmicrosoft.com domain for tenant
4. Constructs SharePoint admin URL from tenant name
5. Runs compliance assessment with detected information

### Benefits

- **Faster**: No need to look up tenant information
- **Easier**: One command to run everything
- **User-Friendly**: Works like official Microsoft assessment tools
- **Error-Proof**: No typos in URLs or domains

### Backwards Compatible

All existing scripts continue to work! Manual parameters are still supported.

## v2.2.5 - Enhanced Microsoft.Graph Auto-Update (CRITICAL)

### Critical Fix
- **Aggressive Microsoft.Graph Cleanup**: Now FORCEFULLY uninstalls ALL outdated Microsoft.Graph versions (< 2.0.0) BEFORE importing
- **Module Load Guarantee**: Module now ALWAYS loads successfully, even if Microsoft.Graph is broken
- **Import-Time Fix**: Microsoft.Graph version is checked and fixed during Import-Module, not just when running commands

### What This Fixes
User-reported issue in v2.2.4:
- "Invoke-CISBenchmark is not recognized" after Install-Module + Import-Module
- Module failed to export functions when Microsoft.Graph import failed
- Auto-update wasn't aggressive enough to remove stubborn old versions

### How v2.2.5 Works
1. When you run `Import-Module CIS-M365-Benchmark`, it immediately checks Microsoft.Graph version
2. If < 2.0.0 detected, it UNINSTALLS all old versions one by one, then installs latest
3. Module functions are ALWAYS exported, even if Microsoft.Graph is completely broken
4. Detailed progress shown during Microsoft.Graph cleanup

### Tested Scenarios
- Fresh install with no Microsoft.Graph: Installs latest automatically
- Old Microsoft.Graph installed: Removes old, installs new automatically
- Broken Microsoft.Graph: Module still loads, fix applied on import

### Manual Fix (if still needed)
Extremely unlikely to be needed, but if auto-update somehow fails:
```powershell
Get-InstalledModule Microsoft.Graph -AllVersions | Uninstall-Module -Force
Install-Module Microsoft.Graph -Force -AllowClobber
Import-Module CIS-M365-Benchmark
```

## v2.2.3 - Improved Compatibility and Auto-Update

### New Features
- **Zero-Configuration Setup**: Prerequisites install automatically when you import the module!
- No prompts, no manual steps - just import and go
- All 5 required modules install automatically if missing:
  - Microsoft.Graph
  - ExchangeOnlineManagement
  - Microsoft.Online.SharePoint.PowerShell
  - MicrosoftTeams
  - MSOnline

### Improved User Experience
- **Two-Step Installation**: Install module â†’ Run compliance check (that's it!)
- Progress feedback shown for each module installation
- Silent installation with visual confirmation
- Ready to use immediately after import

### Usage
The simplest installation ever:
```powershell
# Step 1: Install the module
Install-Module -Name CIS-M365-Benchmark -Scope CurrentUser

# Step 2: Run compliance check (module auto-imports and installs dependencies)
Invoke-CISBenchmark -TenantDomain "tenant.onmicrosoft.com" -SharePointAdminUrl "https://tenant-admin.sharepoint.com"
```

That's it! No manual prerequisite installation needed.

See CHANGELOG.md for complete details.
'@

        # Prerelease string of this module
        # Prerelease = ''

        # Flag to indicate whether the module requires explicit user acceptance for install/update/save
        RequireLicenseAcceptance = $false

        # External dependent modules of this module
        # ExternalModuleDependencies = @()

    } # End of PSData hashtable

} # End of PrivateData hashtable

# HelpInfo URI of this module
HelpInfoURI = 'https://github.com/mohammedsiddiqui6872/CIS-Microsoft-365-Foundations-Benchmark-v5.0.0/blob/main/README.md'

# Default prefix for commands exported from this module. Override the default prefix using Import-Module -Prefix.
# DefaultCommandPrefix = ''

}
